<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="dat.gui.js"></script>
    <meta charset="utf-8" />
    <title>Canvas</title>
</head>

<body>
    <canvas id="canvas">
        Your Browser does not support the canvas tag
    </canvas>

    <script>
    $(function() {
       
        var Config = function() {
            this.balls = 250;
            this.canvasHeight = 900;
            this.canvasWidth = 600;
            this.maxRadius = 1;
            this.minRadius = 1;
            this.maxVelocity = 10;
            this.minVelocity = 0.5;
            this.maxMass = 5;
            this.minMass = 1;
            this.frameRate = 30;
            this.start = startGame;
            this.stop = stopGame;
        };

        var initControls = function() {
            var config = new Config();
             var gui = new dat.GUI();
             gui.add(config, 'balls', 2, 1000);
             gui.add(config, 'canvasHeight', 10, 1000);
             gui.add(config, 'canvasWidth', 10, 1000);
             gui.add(config, 'maxRadius', 0.01, 10);
             gui.add(config, 'minRadius', 0.01, 10);
             gui.add(config, 'maxVelocity', 0, 10);
             gui.add(config, 'minVelocity', 0, 10);
             gui.add(config, 'maxMass', 1, 1000);
             gui.add(config, 'minMass', 1, 1000);
             gui.add(config, 'frameRate', 1, 100);
             gui.add(config, 'start')
             gui.add(config, 'stop')
             return config;
        };

        function initialiseCanvas(width, height) {
            //find the canvas element using its id attribute.
            canvas = document.getElementById('canvas');
            //once canvas is created, create the simulation passing the width and height of canvas
            canvas.width = width;
            canvas.height = height;

            if (!canvas) {
                alert('Error: cannot find the canvas element!');
                return;
            }
            if (!canvas.getContext) {
                alert('Error: no canvas.getContent!');
                return;
            }
            context = canvas.getContext('2d');
            if (!context) {
                alert('Error: failed to getContent');
                return;
            }
            console.log("CANVAS INITIALIZED");
            return context;
        }

        function connectToWs() {
            if (window["WebSocket"]) {
                conn = new WebSocket("ws://localhost:8080/ws");
                conn.onclose = function(evt) {
                    console.log("connection closed");
                }
                conn.onmessage = function(evt) {
                    console.log("Msg received : " + evt.data);
                    balls = JSON.parse(evt.data)
                    if (balls.length > 1)
                        renderer.draw(context, balls);
                }
            } else {
                console.log("Your browser does not support WebSockets");
            }
        }

        var startGame = function() {
            console.log("SIMULATION START")
            $.ajax({
                url: "/simulation/start",
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(config),
                contentType: 'application/json; charset=utf-8',
                success: function() {
                    console.log("Started !!")
                }
            });
        };

        var stopGame = function(event) {
            console.log("SIMULATION STOP")
            $.get("/simulation/stop");
        };

        var Renderer = (function() {
            var canvasColour;

            function Renderer(inCanvasColour) {
                canvasColour = inCanvasColour;
            };

            Renderer.prototype.draw = function(context, ballArray) {
                //console.log(ballArray);
                // draw Canvas Background.
                drawCanvasBackground(context);
                // draw Balls.
                drawBalls(context, ballArray);
            }

            function drawCanvasBackground(context) {
                context.beginPath();
                context.fillStyle = canvasColour;
                context.fillRect(0, 0, canvas.width, canvas.height);
            }

            function drawBalls(context, ballArray) {
                for (var i = 0; i < ballArray.length; i++) {
                    context.beginPath();
                    // draw ball using ball objects data.
                    context.arc(ballArray[i][0], ballArray[i][1], ballArray[i][2], 0, Math.PI * 2, false);
                    context.strokeStyle = ballArray[i][3];
                    context.stroke();
                    context.fillStyle = ballArray[i][3];
                    context.fill();
                    context.closePath();
                }
            }
            return Renderer;
        })();

        var conn;
        var config;
        var balls;
        var renderer;
        var canvas;
        var context;

        var config = initControls();
        var context = initialiseCanvas(config.canvasWidth, config.canvasHeight);
        var renderer = new Renderer('#fff'); // takes colour for canvas.
        connectToWs();
    });
    </script>
</body>

</html>
