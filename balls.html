<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <meta charset="utf-8" />
    <title>Canvas</title>
</head>

<body>
    <canvas id="canvas" width="600" height="300">
        Your Browser does not support the canvas tag
    </canvas>

    <button id="action">START</button>
    <input id="numberOfBalls" type="number" min="1" max="20" />
    <script>
    $(function() {
        var conn;
        var balls;
        var renderer;
        var canvas;
        var canvasHeigth = 1200;
        var canvasWidth = 1800;
        var context;

        function initialiseCanvas() {
            //find the canvas element using its id attribute.
            canvas = document.getElementById('canvas');
            //once canvas is created, create the simulation passing the width and height of canvas
            canvas.width = canvasWidth;
            canvas.height = canvasHeigth;
            renderer = new Renderer('#fff'); // takes colour for canvas.

            if (!canvas) {
                alert('Error: cannot find the canvas element!');
                return;
            }
            if (!canvas.getContext) {
                alert('Error: no canvas.getContent!');
                return;
            }
            context = canvas.getContext('2d');
            if (!context) {
                alert('Error: failed to getContent');
                return;
            }
            console.log("CANVAS INITIALIZED");
            connectToWs();
        }

        function connectToWs() {
            if (window["WebSocket"]) {
                conn = new WebSocket("ws://localhost:8080/ws");
                conn.onclose = function(evt) {
                    console.log("connection closed");
                }
                conn.onmessage = function(evt) {
                    console.log("Msg received : " + evt.data);
                    balls = JSON.parse(evt.data)
                    if (balls.length > 1)
                        renderer.draw(context, balls);
                }
            } else {
                console.log("Your browser does not support WebSockets");
            }

            $("#action").click(startGame);
        }

        var Renderer = (function(Context) {
            var canvasColour;

            function Renderer(inCanvasColour) {
                canvasColour = inCanvasColour;
            };

            Renderer.prototype.draw = function(context, ballArray) {
                //console.log(ballArray);
                // draw Canvas Background.
                drawCanvasBackground(context);
                // draw Balls.
                drawBalls(context, ballArray);
            }

            function drawCanvasBackground(context) {
                context.beginPath();
                context.fillStyle = canvasColour;
                context.fillRect(0, 0, canvas.width, canvas.height);
            }

            function drawBalls(context, ballArray) {
                for (var i = 0; i < ballArray.length; i++) {
                    context.beginPath();
                    // draw ball using ball objects data.
                    context.arc(ballArray[i][0], ballArray[i][1], ballArray[i][2], 0, Math.PI * 2, false);
                    context.strokeStyle = ballArray[i][3];
                    context.stroke();
                    context.fillStyle = ballArray[i][3];
                    context.fill();
                    context.closePath();
                }
            }

            return Renderer;
        })();

        var startGame = function(event) {
            console.log("SIMULATION START")
            $(this).unbind("click");
            $.get("/simulation/start?balls_count=" + $("#numberOfBalls").val());
            $(this).click(stopGame);
            $(this).html("STOP");
        };

        var stopGame = function(event) {
            console.log("SIMULATION STOP")
            $(this).unbind("click");
            $.get("/simulation/stop");
            $(this).click(startGame);
            $(this).html("START");
        };

        initialiseCanvas();
    });
    </script>
</body>

</html>
