<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <meta charset="utf-8" />
    <link href="slider.css" type="text/css" rel="stylesheet" />
    <title>Canvas</title>
</head>

<body>
    <canvas id="canvas" width="600" height="300">
        Your Browser does not support the canvas tag
    </canvas>

    <style>
        .slider_c {
            background: linear-gradient(90deg,  rgb(244, 180, 0), 
                                                rgb(244, 180, 0) 34%, 
                                                rgb(204, 204, 204) 34%, 
                                                rgb(204, 204, 204));
            display: block;
            width: 300px;
        }
    </style>

    <button id="action">START</button>
    <input id="numberOfBalls" type="range" min="0" max="250" value="25" step="1" class="slider_c" />
    <input id="canvasHeight" type="range" min="600" max="2000" value="1000" step="100" class="slider_c">
    <input id="canvasWidth" type="range" min="900" max="2000" value="1000" step="100" class="slider_c">
    <input id="maxRadius" type="range" min="1" max="10" value="1" step="0.5" class="slider_c">
    <input id="minRadius" type="range" min="1" max="10" value="1" step="0.5" class="slider_c">
    <input id="maxVelocity" type="range" min="0" max="25" value="5" step="1" class="slider_c">
    <input id="minVelocity" type="range" min="0" max="25" value="5" step="1" class="slider_c">
    <input id="maxMass" type="range" min="0" max="250" value="5" step="1" class="slider_c">
    <input id="minMass" type="range" min="0" max="10" value="5" step="1" class="slider_c">
    <input id="frameRate" type="range" min="1" max="100" value="30" step="1" class="slider_c">

    <script>
    $(function() {
        var conn;
        var balls;
        var renderer;
        var canvas;
        var context;

        function initialiseCanvas() {
            //find the canvas element using its id attribute.
            canvas = document.getElementById('canvas');
            //once canvas is created, create the simulation passing the width and height of canvas
            canvas.width = $("#canvasWidth").val();
            canvas.height = $("#canvasHeigth").val();
            renderer = new Renderer('#fff'); // takes colour for canvas.

            if (!canvas) {
                alert('Error: cannot find the canvas element!');
                return;
            }
            if (!canvas.getContext) {
                alert('Error: no canvas.getContent!');
                return;
            }
            context = canvas.getContext('2d');
            if (!context) {
                alert('Error: failed to getContent');
                return;
            }
            console.log("CANVAS INITIALIZED");
            connectToWs();
        }

        function connectToWs() {
            if (window["WebSocket"]) {
                conn = new WebSocket("ws://localhost:8080/ws");
                conn.onclose = function(evt) {
                    console.log("connection closed");
                }
                conn.onmessage = function(evt) {
                    console.log("Msg received : " + evt.data);
                    balls = JSON.parse(evt.data)
                    if (balls.length > 1)
                        renderer.draw(context, balls);
                }
            } else {
                console.log("Your browser does not support WebSockets");
            }

            $("#action").click(startGame);
        }

        var Renderer = (function(Context) {
            var canvasColour;

            function Renderer(inCanvasColour) {
                canvasColour = inCanvasColour;
            };

            Renderer.prototype.draw = function(context, ballArray) {
                //console.log(ballArray);
                // draw Canvas Background.
                drawCanvasBackground(context);
                // draw Balls.
                drawBalls(context, ballArray);
            }

            function drawCanvasBackground(context) {
                context.beginPath();
                context.fillStyle = canvasColour;
                context.fillRect(0, 0, canvas.width, canvas.height);
            }

            function drawBalls(context, ballArray) {
                for (var i = 0; i < ballArray.length; i++) {
                    context.beginPath();
                    // draw ball using ball objects data.
                    context.arc(ballArray[i][0], ballArray[i][1], ballArray[i][2], 0, Math.PI * 2, false);
                    context.strokeStyle = ballArray[i][3];
                    context.stroke();
                    context.fillStyle = ballArray[i][3];
                    context.fill();
                    context.closePath();
                }
            }

            return Renderer;
        })();

        var startGame = function(event) {
            console.log("SIMULATION START")
            $(this).unbind("click");
            var configuration = {
                canvasHeigth: $("#canvasHeigth").val(),
                canvasWidth: $("#canvasWidth").val(),
                maxRadius: $("#maxRadius").val(),
                minRadius: $("#minRadius").val(),
                maxVelocity: $("#maxVelocity").val(),
                minVelocity: $("#minVelocity").val(),
                maxMass: $("#maxMass").val(),
                minMass: $("#minMass").val(),
                frameRate: $("#frameRate").val()
            };
            $.post("/simulation/start?", configuration);
            $(this).click(stopGame);
            $(this).html("STOP");
        };

        var stopGame = function(event) {
            console.log("SIMULATION STOP")
            $(this).unbind("click");
            $.get("/simulation/stop");
            $(this).click(startGame);
            $(this).html("START");
        };

        initialiseCanvas();
    });
    </script>
</body>

</html>
